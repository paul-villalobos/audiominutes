# üìä Plan de Implementaci√≥n: Indicadores de Crecimiento y Costos

## üéØ Objetivo

Implementar un sistema completo de m√©tricas para medir **Activaci√≥n**, **Retenci√≥n**, **Referral** y **Costos** que permita definir un modelo de pricing sostenible y optimizar el crecimiento del negocio.

## üìã Resumen Ejecutivo

### Indicadores a Implementar

- **üîπ Activaci√≥n**: N√∫mero de actas generadas por semana, % de usuarios que llegan al aha moment
- **üîÑ Retenci√≥n**: 2nd Acta Rate, APU/week, Retention Curve
- **üì§ Referral**: % de actas compartidas, Invitation Rate
- **üí∞ Costos**: Costo por acta, costo por usuario/mes, desglose por proveedor

### Modelo de Datos

- **2 tablas principales**: `user_events` (eventos at√≥micos) y `user_profiles` (perfiles de usuario)
- **BI-friendly**: Estructura compatible con Power BI, Tableau, SQL directo
- **Escalable**: F√°cil agregar nuevos eventos y m√©tricas

---

## üèóÔ∏è Arquitectura del Sistema

### 1. Modelo de Datos

#### Tabla: `user_events` (Eventos At√≥micos)

```python
class UserEvent(Base):
    __tablename__ = "user_events"

    # Claves
    id = Column(Integer, primary_key=True)
    event_id = Column(String(36), unique=True, nullable=False)  # UUID
    user_email = Column(String(255), nullable=False, index=True)

    # Tiempo
    event_datetime = Column(DateTime, nullable=False, index=True)

    # Dimensiones de negocio
    event_type = Column(String(50), nullable=False, index=True)
    event_category = Column(String(30), nullable=False, index=True)  # 'activation', 'retention', 'referral', 'cost'

    # M√©tricas num√©ricas
    duration_minutes = Column(Float, nullable=True)  # Duraci√≥n del audio
    file_size_mb = Column(Float, nullable=True)  # Tama√±o del archivo
    cost_usd = Column(Float, nullable=True)  # Costo del evento

    # Dimensiones adicionales
    user_cohort = Column(String(20), nullable=True, index=True)  # Calculado autom√°ticamente
    referral_source = Column(String(50), nullable=True, index=True)

    # Datos flexibles
    event_metadata = Column(JSON, nullable=True)  # Datos espec√≠ficos del evento
    cost_breakdown = Column(JSON, nullable=True)  # Desglose de costos

    # Auditor√≠a
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

#### Tabla: `user_profiles` (Perfiles de Usuario)

```python
class UserProfile(Base):
    __tablename__ = "user_profiles"

    # Clave primaria
    email = Column(String(255), primary_key=True)

    # Fechas importantes
    first_seen_date = Column(Date, nullable=False, index=True)
    first_acta_date = Column(Date, nullable=True, index=True)
    last_activity_date = Column(Date, nullable=True, index=True)

    # M√©tricas pre-calculadas
    total_actas = Column(Integer, default=0, nullable=False)
    total_downloads = Column(Integer, default=0, nullable=False)
    total_shares = Column(Integer, default=0, nullable=False)
    total_referrals = Column(Integer, default=0, nullable=False)
    total_cost_usd = Column(Float, default=0, nullable=False)

    # Dimensiones de usuario
    user_cohort = Column(String(20), nullable=False, index=True)
    user_segment = Column(String(30), nullable=True, index=True)  # 'new', 'active', 'churned', 'power_user'
    referral_source = Column(String(50), nullable=True, index=True)

    # Flags de estado
    is_activated = Column(Boolean, default=False, nullable=False, index=True)
    is_retained = Column(Boolean, default=False, nullable=False, index=True)
    is_referrer = Column(Boolean, default=False, nullable=False, index=True)

    # Auditor√≠a
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 2. Servicios de Tracking

#### Servicio: `MetricsService`

```python
class MetricsService:
    """Servicio para tracking de m√©tricas y eventos."""

    def __init__(self, db_session):
        self.db = db_session

    def track_event(self, event_type: str, user_email: str, event_data: dict):
        """Registrar evento en la base de datos."""
        pass

    def calculate_user_cohort(self, date: datetime) -> str:
        """Calcular cohorte basada en la fecha."""
        pass

    def update_user_profile(self, user_email: str, event_data: dict):
        """Actualizar perfil de usuario con nuevos datos."""
        pass

    def get_activation_metrics(self, start_date: date, end_date: date) -> dict:
        """Calcular m√©tricas de activaci√≥n."""
        pass

    def get_retention_metrics(self, start_date: date, end_date: date) -> dict:
        """Calcular m√©tricas de retenci√≥n."""
        pass

    def get_referral_metrics(self, start_date: date, end_date: date) -> dict:
        """Calcular m√©tricas de referral."""
        pass

    def get_cost_metrics(self, start_date: date, end_date: date) -> dict:
        """Calcular m√©tricas de costos."""
        pass
```

---

## üìä Eventos a Capturar

### üîπ ACTIVACI√ìN (Aha Moment)

#### Eventos:

1. **`form_submit`**

   - **Cu√°ndo**: Usuario env√≠a formulario con email y archivo
   - **D√≥nde**: Al inicio del endpoint `/transcribe`
   - **Datos**: `email`, `filename`, `file_size_mb`
   - **Prop√≥sito**: Contar usuarios que intentan usar el servicio

2. **`acta_generated`**

   - **Cu√°ndo**: Acta generada exitosamente y enviada por email
   - **D√≥nde**: Al final del endpoint `/transcribe` (despu√©s de enviar email)
   - **Datos**: `email`, `filename`, `duration_minutes`, `file_size_mb`
   - **Prop√≥sito**: Contar usuarios que llegan al "aha moment"

3. **`acta_downloaded`**
   - **Cu√°ndo**: Usuario descarga acta desde el email
   - **D√≥nde**: Tracking en email (pixel tracking o link tracking)
   - **Datos**: `email`, `filename`, `download_timestamp`
   - **Prop√≥sito**: Confirmar que el usuario realmente recibi√≥ y us√≥ el acta

#### Indicadores:

- **Actas generadas por semana**: Contar eventos `acta_generated` por semana
- **% Activaci√≥n**: `(usuarios con acta_generated) √∑ (usuarios con form_submit)`

### üîÑ RETENCI√ìN (Repetici√≥n del Aha)

#### Eventos:

4. **`second_acta_generated`**

   - **Cu√°ndo**: Usuario genera su segunda acta
   - **D√≥nde**: Al final del endpoint `/transcribe` (si es segunda acta del usuario)
   - **Datos**: `email`, `filename`, `duration_minutes`, `days_since_first_acta`
   - **Prop√≥sito**: Medir 2nd Acta Rate

5. **`weekly_acta_generated`**

   - **Cu√°ndo**: Usuario genera acta en semana diferente a la anterior
   - **D√≥nde**: Al final del endpoint `/transcribe`
   - **Datos**: `email`, `filename`, `week_number`, `actas_this_week`
   - **Prop√≥sito**: Medir APU/week (Actas por Usuario por semana)

6. **`retention_check`**
   - **Cu√°ndo**: Usuario genera acta despu√©s de X d√≠as
   - **D√≥nde**: Al final del endpoint `/transcribe`
   - **Datos**: `email`, `filename`, `days_since_first_acta`, `retention_period`
   - **Prop√≥sito**: Medir Retention Curve (D√≠a 1, 7, 30)

#### Indicadores:

- **2nd Acta Rate**: % usuarios que generan segunda acta en 7 d√≠as
- **APU/week**: Actas por usuario por semana
- **Retention Curve**: Retenci√≥n en d√≠as 1, 7, 30

### üì§ REFERRAL (Viral Loop)

#### Eventos:

7. **`acta_shared`**

   - **Cu√°ndo**: Usuario comparte acta (link o forward)
   - **D√≥nde**: Tracking en email o en dashboard
   - **Datos**: `email`, `filename`, `share_method`, `share_timestamp`
   - **Prop√≥sito**: Medir % de actas compartidas

8. **`referral_sent`**

   - **Cu√°ndo**: Usuario recomienda VoxCliente a un colega
   - **D√≥nde**: Formulario de referido o bot√≥n de compartir
   - **Datos**: `email`, `referral_email`, `referral_method`, `referral_timestamp`
   - **Prop√≥sito**: Medir Invitation Rate

9. **`referral_converted`**
   - **Cu√°ndo**: Usuario referido genera su primera acta
   - **D√≥nde**: Al final del endpoint `/transcribe` (si es usuario referido)
   - **Datos**: `email`, `referrer_email`, `filename`, `conversion_timestamp`
   - **Prop√≥sito**: Medir efectividad de referidos

#### Indicadores:

- **% Actas compartidas**: Actas compartidas en primeros 7 d√≠as
- **Invitation Rate**: Usuarios que recomiendan VoxCliente despu√©s del primer aha

### üí∞ COSTOS (Modelo de Pricing)

#### Eventos:

10. **`transcription_cost`**

    - **Cu√°ndo**: Despu√©s de transcribir audio con AssemblyAI
    - **Datos**: `duration_minutes`, `cost_usd`, `provider` (AssemblyAI)
    - **C√°lculo**: `duration_minutes * $0.006`

11. **`llm_processing_cost`**

    - **Cu√°ndo**: Despu√©s de generar acta con OpenAI
    - **Datos**: `input_tokens`, `output_tokens`, `cost_usd`, `model` (GPT-4.1-mini)
    - **C√°lculo**: `(input_tokens * $0.00015 + output_tokens * $0.0006) / 1000`

12. **`email_cost`**

    - **Cu√°ndo**: Despu√©s de enviar email con Resend
    - **Datos**: `email_count`, `cost_usd`, `provider` (Resend)
    - **C√°lculo**: `email_count * $0.0004`

13. **`total_acta_cost`**
    - **Cu√°ndo**: Al final del proceso completo
    - **Datos**: `total_cost_usd`, `cost_breakdown`, `user_email`
    - **C√°lculo**: `transcription_cost + llm_processing_cost + email_cost`

#### Indicadores:

- **Costo Promedio por Acta (CPA)**: `total_cost_usd / total_actas_generated`
- **Costo Promedio por Usuario al Mes (CPU/Month)**: `SUM(total_cost_usd) / COUNT(DISTINCT user_email) / months`
- **Costo por Minuto de Audio**: `SUM(transcription_cost) / SUM(duration_minutes)`
- **Costo por Token de LLM**: `SUM(llm_processing_cost) / SUM(input_tokens + output_tokens)`

---

## üöÄ Plan de Implementaci√≥n

### Fase 1: Fundaci√≥n (Semana 1)

**Objetivo**: Crear modelo de datos y servicios b√°sicos

#### Tareas:

1. **Crear modelos de datos**

   - Implementar `UserEvent` y `UserProfile` en `models.py`
   - Crear migraci√≥n de base de datos
   - Configurar √≠ndices para rendimiento

2. **Crear `MetricsService`**

   - Implementar funciones b√°sicas de tracking
   - Funci√≥n para calcular cohortes
   - Funci√≥n para actualizar perfiles de usuario

3. **Modificar endpoint `/transcribe`**
   - Agregar tracking de eventos b√°sicos
   - Registrar `form_submit` al inicio
   - Registrar `acta_generated` al final
   - Mantener compatibilidad con c√≥digo existente

#### Entregables:

- ‚úÖ Modelos de datos implementados
- ‚úÖ Migraci√≥n de base de datos creada
- ‚úÖ `MetricsService` b√°sico funcionando
- ‚úÖ Endpoint `/transcribe` con tracking b√°sico

### Fase 2: M√©tricas Core (Semana 2)

**Objetivo**: Implementar c√°lculo de m√©tricas principales

#### Tareas:

1. **Implementar m√©tricas de activaci√≥n**

   - Funci√≥n para calcular % de activaci√≥n
   - Funci√≥n para contar actas por semana
   - Endpoint `/metrics/activation`

2. **Implementar m√©tricas de retenci√≥n**

   - Funci√≥n para calcular 2nd Acta Rate
   - Funci√≥n para calcular APU/week
   - Funci√≥n para calcular Retention Curve
   - Endpoint `/metrics/retention`

3. **Implementar m√©tricas de referral**
   - Funci√≥n para calcular % de actas compartidas
   - Funci√≥n para calcular Invitation Rate
   - Endpoint `/metrics/referral`

#### Entregables:

- ‚úÖ Endpoints de m√©tricas funcionando
- ‚úÖ C√°lculos de activaci√≥n, retenci√≥n y referral
- ‚úÖ Testing de m√©tricas

### Fase 3: Tracking de Costos (Semana 3)

**Objetivo**: Implementar tracking detallado de costos

#### Tareas:

1. **Modificar servicios para tracking de costos**

   - `AssemblyAIService`: Calcular costo de transcripci√≥n
   - `OpenAIService`: Calcular costo de tokens
   - `ResendEmailService`: Calcular costo de email

2. **Implementar m√©tricas de costos**

   - Funci√≥n para calcular CPA (Costo por Acta)
   - Funci√≥n para calcular CPU/Month (Costo por Usuario/Mes)
   - Funci√≥n para desglose de costos por proveedor
   - Endpoint `/metrics/costs`

3. **Integrar tracking de costos en endpoint `/transcribe`**
   - Registrar eventos de costo
   - Calcular costo total por acta
   - Actualizar perfil de usuario con costos

#### Entregables:

- ‚úÖ Tracking de costos implementado
- ‚úÖ M√©tricas de costos funcionando
- ‚úÖ Desglose de costos por proveedor

### Fase 4: Dashboard y Referral (Semana 4)

**Objetivo**: Crear dashboard y sistema de referral

#### Tareas:

1. **Crear dashboard HTML**

   - P√°gina est√°tica que consume endpoints de m√©tricas
   - Gr√°ficos b√°sicos con Chart.js
   - Dise√±o responsive y simple
   - Actualizaci√≥n autom√°tica cada 5 minutos

2. **Implementar sistema de referral**

   - Botones de compartir en emails
   - Tracking de clicks en links de compartir
   - Sistema simple de referidos con c√≥digos √∫nicos
   - Formulario de referido

3. **Implementar tracking de descarga**
   - Pixel tracking en emails
   - Link tracking para descargas
   - Endpoint `/track/download`

#### Entregables:

- ‚úÖ Dashboard HTML funcionando
- ‚úÖ Sistema de referral implementado
- ‚úÖ Tracking de descarga funcionando

### Fase 5: Refinamiento y Optimizaci√≥n (Semana 5)

**Objetivo**: Optimizar rendimiento y agregar funcionalidades avanzadas

#### Tareas:

1. **Optimizar consultas**

   - Revisar y optimizar √≠ndices
   - Implementar consultas eficientes
   - Agregar caching para m√©tricas frecuentes

2. **Agregar funcionalidades avanzadas**

   - Exportaci√≥n de datos en CSV/JSON
   - Alertas por email para m√©tricas cr√≠ticas
   - Comparaci√≥n de cohortes
   - An√°lisis de tendencias

3. **Documentaci√≥n y testing**
   - Documentar endpoints de m√©tricas
   - Crear ejemplos de uso
   - Testing completo del sistema
   - Documentaci√≥n para herramientas BI

#### Entregables:

- ‚úÖ Sistema optimizado y documentado
- ‚úÖ Exportaci√≥n de datos implementada
- ‚úÖ Testing completo
- ‚úÖ Documentaci√≥n para BI

---

## üìä Endpoints de M√©tricas

### Endpoints de Growth

```
GET /metrics/activation
GET /metrics/retention
GET /metrics/referral
GET /metrics/summary
```

### Endpoints de Costos

```
GET /metrics/costs/summary
GET /metrics/costs/per-user
GET /metrics/costs/per-acta
GET /metrics/costs/breakdown
```

### Endpoints de Exportaci√≥n

```
GET /export/events?start_date=2024-01-01&end_date=2024-12-31&format=csv
GET /export/metrics/daily?start_date=2024-01-01&end_date=2024-12-31
GET /export/users?segment=active&format=csv
```

### Endpoints de Tracking

```
GET /track/download?email=user@example.com&filename=meeting.wav
POST /track/share
POST /track/referral
```

---

## üí° Ejemplos de Respuestas de API

### GET /metrics/activation

```json
{
  "activation": {
    "actas_this_week": 45,
    "activation_rate": 0.78,
    "total_users": 120,
    "activated_users": 94,
    "trend_7_days": 0.15
  }
}
```

### GET /metrics/retention

```json
{
  "retention": {
    "second_acta_rate": 0.35,
    "apu_this_week": 1.8,
    "retention_curve": {
      "day_1": 0.95,
      "day_7": 0.42,
      "day_30": 0.18
    },
    "cohort_analysis": {
      "2024-W01": { "users": 25, "retention_30d": 0.2 },
      "2024-W02": { "users": 30, "retention_30d": 0.25 }
    }
  }
}
```

### GET /metrics/costs/summary

```json
{
  "costs": {
    "total_cost_usd": 125.5,
    "total_actas": 450,
    "total_users": 120,
    "avg_cost_per_acta": 0.28,
    "avg_cost_per_user_month": 1.05,
    "cost_breakdown": {
      "transcription": 67.5,
      "llm_processing": 45.2,
      "email": 12.8
    },
    "pricing_recommendations": {
      "pay_per_use": 2.99,
      "monthly_subscription": 9.99,
      "annual_subscription": 99.99
    }
  }
}
```

---

## üéØ Modelo de Pricing Recomendado

### An√°lisis de Costos Base

- **Costo por acta**: ~$0.28 (transcripci√≥n + LLM + email)
- **Costo por usuario/mes**: ~$1.05 (4 actas promedio)
- **Margen recomendado**: 3-5x el costo

### Opciones de Pricing

1. **Pay-per-use**: $2.99 por acta (10x margen)
2. **Suscripci√≥n Mensual**: $9.99/mes hasta 10 actas (9x margen)
3. **Suscripci√≥n Anual**: $99.99/a√±o hasta 120 actas (8x margen)
4. **Enterprise**: $29.99/mes actas ilimitadas (variable)

---

## üîß Configuraci√≥n T√©cnica

### Variables de Entorno

```bash
# Costos por proveedor
ASSEMBLYAI_COST_PER_MINUTE=0.006
OPENAI_INPUT_COST_PER_1K_TOKENS=0.00015
OPENAI_OUTPUT_COST_PER_1K_TOKENS=0.0006
RESEND_COST_PER_EMAIL=0.0004

# Configuraci√≥n de m√©tricas
METRICS_RETENTION_DAYS=30
METRICS_COHORT_WEEKS=12
METRICS_UPDATE_INTERVAL=300
```

### √çndices de Base de Datos

```sql
-- √çndices para rendimiento
CREATE INDEX idx_user_events_email_datetime ON user_events(user_email, event_datetime);
CREATE INDEX idx_user_events_type_category ON user_events(event_type, event_category);
CREATE INDEX idx_user_events_cohort ON user_events(user_cohort);
CREATE INDEX idx_user_profiles_cohort ON user_profiles(user_cohort);
CREATE INDEX idx_user_profiles_segment ON user_profiles(user_segment);
```

---

## üìà M√©tricas de √âxito

### KPIs Principales

- **Activaci√≥n**: >70% de usuarios que env√≠an formulario generan acta
- **Retenci√≥n**: >30% de usuarios generan segunda acta en 7 d√≠as
- **Referral**: >15% de usuarios comparten actas en primeros 7 d√≠as
- **Costos**: <$0.30 por acta generada

### M√©tricas de Rendimiento

- **Tiempo de respuesta**: <2 segundos para endpoints de m√©tricas
- **Disponibilidad**: >99.5% uptime
- **Precisi√≥n**: 100% de eventos trackeados correctamente

---

## üö® Consideraciones Importantes

### Privacidad y Seguridad

- ‚úÖ No almacenar datos sensibles en eventos
- ‚úÖ Anonimizar datos para exportaci√≥n
- ‚úÖ Cumplir con GDPR/LOPD
- ‚úÖ Implementar rate limiting en endpoints

### Escalabilidad

- ‚úÖ √çndices optimizados para consultas frecuentes
- ‚úÖ Agregaci√≥n de datos para consultas hist√≥ricas
- ‚úÖ Caching de m√©tricas calculadas
- ‚úÖ Monitoreo de rendimiento

### Mantenimiento

- ‚úÖ Logging detallado de eventos
- ‚úÖ Alertas autom√°ticas para m√©tricas cr√≠ticas
- ‚úÖ Backup regular de datos de m√©tricas
- ‚úÖ Documentaci√≥n actualizada

---

## üìö Recursos Adicionales

### Documentaci√≥n

- [Gu√≠a de implementaci√≥n de m√©tricas](docs/metrics-implementation.md)
- [API Reference para m√©tricas](docs/metrics-api.md)
- [Gu√≠a de integraci√≥n con BI](docs/bi-integration.md)

### Herramientas Recomendadas

- **Power BI**: Para dashboards empresariales
- **Tableau**: Para an√°lisis avanzados
- **Grafana**: Para monitoreo en tiempo real
- **PostgreSQL**: Para consultas complejas

### Pr√≥ximos Pasos

1. Revisar y aprobar este plan
2. Asignar recursos y timeline
3. Comenzar implementaci√≥n por fases
4. Monitorear m√©tricas desde el d√≠a 1
5. Iterar y mejorar basado en datos reales

---

**Fecha de creaci√≥n**: $(date)
**Versi√≥n**: 1.0
**Estado**: Pendiente de implementaci√≥n
